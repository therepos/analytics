<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ERM Data Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 20px; }
        .chart { width: 100%; height: 400px; margin-bottom: 40px; }
        label { font-weight: bold; margin-right: 10px; }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/1.13/auth0-spa-js.production.js"></script>
</head>
<body>
    <h1>ERM Data Analytics Dashboard</h1>
    <label for="categoryFilter">Filter by Risk Category:</label>
    <select id="categoryFilter">
        <option value="All">All</option>
    </select>

    <div id="chart1" class="chart"></div>
    <div id="chart2" class="chart"></div>
    <div id="chart3" class="chart"></div>
    <div id="chart4" class="chart"></div>
    <div id="chart5" class="chart"></div>
    <div id="chart6" class="chart"></div>
    <div id="chart7" class="chart"></div>
    <div id="chart8" class="chart"></div>
    <div id="chart9" class="chart"></div>

    <script>
    window.addEventListener("DOMContentLoaded", async () => {
        const isNetlify = location.hostname.includes("netlify.app") || location.hostname === "warm-biscochitos-010ccc.netlify.app";

        if (isNetlify) {
            const auth0 = await createAuth0Client({
                domain: "dev-o1tvtsc3fv5nyk32.us.auth0.com",
                client_id: "tvMlCF8FOMZCTSjeejVpJs8bqqAiNKmm"
            });

            const isAuthenticated = await auth0.isAuthenticated();
            if (!isAuthenticated) {
                await auth0.loginWithRedirect();
                return;
            }
        }

        Papa.parse("risk_data.csv", {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                const data = results.data;
                const dropdown = document.getElementById("categoryFilter");
                const uniqueCategories = [...new Set(data.map(d => d.Risk_Category))];
                uniqueCategories.forEach(cat => {
                    const opt = document.createElement("option");
                    opt.value = cat;
                    opt.text = cat;
                    dropdown.appendChild(opt);
                });

                dropdown.addEventListener("change", () => {
                    const selected = dropdown.value;
                    const filtered = selected === "All" ? data : data.filter(d => d.Risk_Category === selected);
                    drawCharts(filtered);
                });

                drawCharts(data);

                function drawCharts(filtered) {
                    // all charting logic would go here (as you already have)
                }
            }
        });
    });
    </script>
</body>
</html>
